// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.15;

import "forge-std/Test.sol";

import {NFTEnhancement} from "src/NFTEnhancement.sol";
import {Glitch} from "src/renderers/Glitch.sol";
import {ERC721} from "src/ERC721.sol";

contract NFTEnhancementTest is Test {
    NFTEnhancement public enhancement;
    address public constant alice = address(0xABCD);
    string internal constant tokenName = "GLITCH";
    address internal renderer;
    uint96 internal constant tokenQualifier = 0;
    uint256 internal tokenId;

    address internal constant BAYC =
        address(0xBC4CA0EdA7647A8aB7C2061c2E118A18a936f13D);
    address internal constant underlyingTokenContract = BAYC;
    uint256 internal constant underlyingTokenId = 1234;

    function setUp() public {
        enhancement = new NFTEnhancement("NFT Filters", "FLTRS");
        renderer = address(new Glitch());
        tokenId = enhancement.composeTokenId(renderer, tokenQualifier);
    }

    function testMint() public {
        address recipient = address(this);
        enhancement.mint(recipient, renderer, tokenQualifier, tokenName);

        assertEq(enhancement.ownerOf(tokenId), recipient);
    }

    function testMintAuthorizedOnly() public {
        address recipient = address(this);

        vm.startPrank(alice);
        vm.expectRevert(ERC721.Unauthorized.selector);
        enhancement.mint(recipient, renderer, tokenQualifier, tokenName);
        vm.stopPrank();
    }

    function testSetUnderlyingToken() public {
        address recipient = address(this);
        enhancement.mint(recipient, renderer, tokenQualifier, tokenName);

        enhancement.setUnderlyingToken(
            tokenId, underlyingTokenContract, underlyingTokenId
        );

        (address _underlyingTokenContract, uint256 _underlyingTokenId) =
            enhancement.getUnderlyingToken(tokenId);
        assertEq(_underlyingTokenContract, underlyingTokenContract);
        assertEq(_underlyingTokenId, underlyingTokenId);
    }

    function testSetUnderlyingTokenAuthorizedOnly() public {
        address recipient = address(alice);
        enhancement.mint(recipient, renderer, tokenQualifier, tokenName);

        vm.expectRevert(ERC721.Unauthorized.selector);
        enhancement.setUnderlyingToken(
            tokenId, underlyingTokenContract, underlyingTokenId
        );
        vm.stopPrank();
    }

    function testTokenURI() public {
        address recipient = address(this);
        enhancement.mint(recipient, renderer, tokenQualifier, tokenName);

        enhancement.setUnderlyingToken(
            tokenId, underlyingTokenContract, underlyingTokenId
        );

        string memory tokenURI = enhancement.tokenURI(tokenId);
        string memory metadata =
            "data:application/json;base64,eyJuYW1lIjoiR0xJVENIIiwiZGVzY3JpcHRpb24iOiJBcHBsaWVkIHRvIEJBWUMjMTIzNCAoMHhiYzRjYTBlZGE3NjQ3YThhYjdjMjA2MWMyZTExOGExOGE5MzZmMTNkKSIsImFuaW1hdGlvbl91cmwiOiJkYXRhOnRleHQvaHRtbDtiYXNlNjQsUEdoMGJXd2diR0Z1WnowaVpXNGlQaUE4YUdWaFpENGdQRzFsZEdFZ1kyaGhjbk5sZEQwaWRYUm1MVGdpTHo0Z1BHMWxkR0VnYm1GdFpUMGlkbWxsZDNCdmNuUWlJR052Ym5SbGJuUTlJbmRwWkhSb1BXUmxkbWxqWlMxM2FXUjBhQ3dnYVc1cGRHbGhiQzF6WTJGc1pUMHhJaTgrSUR4MGFYUnNaVDVHVEZSU1V5QXRJRWRzYVhSamFEd3ZkR2wwYkdVK0lEeHRaWFJoSUc1aGJXVTlJbVJsYzJOeWFYQjBhVzl1SWlCamIyNTBaVzUwUFNKSGJHbDBZMmdpTHo0Z1BHMWxkR0VnYm1GdFpUMGlZWFYwYUc5eUlpQmpiMjUwWlc1MFBTSmpiV2xqYUdWc0lpOCtJRHh6ZEhsc1pUNW9kRzFzZTJKdmVDMXphWHBwYm1jNklHSnZjbVJsY2kxaWIzZzdJR2hsYVdkb2REb2dNVEF3ZG1nN2ZTb3NJQ282WW1WbWIzSmxMQ0FxT21GbWRHVnllMkp2ZUMxemFYcHBibWM2SUdsdWFHVnlhWFE3SUhWelpYSXRjMlZzWldOME9pQnViMjVsTzMxaWIyUjVlM2RwWkhSb09pQXhNREIyZHpzZ2FHVnBaMmgwT2lBeE1EQjJhRHNnYldGeVoybHVPaUF3TzMxallXNTJZWE43ZDJsa2RHZzZJREV3TUhaM095Qm9aV2xuYUhRNklERXdNSFpvT3lCa2FYTndiR0Y1T2lCaWJHOWphenNnYldGNExYZHBaSFJvT2lBeE1EQjJkenNnWW05eVpHVnlPaUJ1YjI1bE8zMDhMM04wZVd4bFBpQThMMmhsWVdRK0lEeGliMlI1UGlBOFkyRnVkbUZ6SUdsa1BTSmpZVzUyWVhNaVBqd3ZZMkZ1ZG1GelBpQThjMk55YVhCMElIUjVjR1U5SW5SbGVIUXZhbUYyWVhOamNtbHdkQ0krZG1GeUlIWmxjblJsZUZOb1lXUmxjbE52ZFhKalpUMWdJM1psY25OcGIyNGdNekF3SUdWekNnb3ZMeUJoYmlCaGRIUnlhV0oxZEdVZ2FYTWdZVzRnYVc1d2RYUWdLR2x1S1NCMGJ5QmhJSFpsY25SbGVDQnphR0ZrWlhJdUNpOHZJRWwwSUhkcGJHd2djbVZqWldsMlpTQmtZWFJoSUdaeWIyMGdZU0JpZFdabVpYSUthVzRnZG1Wak1pQmhYM0J2YzJsMGFXOXVPd3BwYmlCMlpXTXlJR0ZmZEdWNFEyOXZjbVE3Q2dvdkx5QlZjMlZrSUhSdklIQmhjM01nYVc0Z2RHaGxJSEpsYzI5c2RYUnBiMjRnYjJZZ2RHaGxJR05oYm5aaGN3cDFibWxtYjNKdElIWmxZeklnZFY5eVpYTnZiSFYwYVc5dU93b0tMeThnVlhObFpDQjBieUJ3WVhOeklIUm9aU0IwWlhoMGRYSmxJR052YjNKa2FXNWhkR1Z6SUhSdklIUm9aU0JtY21GbmJXVnVkQ0J6YUdGa1pYSUtiM1YwSUhabFl6SWdkbDkwWlhoRGIyOXlaRHNLQ2k4dklHRnNiQ0J6YUdGa1pYSnpJR2hoZG1VZ1lTQnRZV2x1SUdaMWJtTjBhVzl1Q25admFXUWdiV0ZwYmlncElIc0tDaUFnTHk4Z1kyOXVkbVZ5ZENCMGFHVWdjRzl6YVhScGIyNGdabkp2YlNCd2FYaGxiSE1nZEc4Z01DNHdJSFJ2SURFdU1Bb2dJSFpsWXpJZ2VtVnliMVJ2VDI1bElEMGdZVjl3YjNOcGRHbHZiaUF2SUhWZmNtVnpiMngxZEdsdmJqc0tDaUFnTHk4Z1kyOXVkbVZ5ZENCbWNtOXRJREF0UGpFZ2RHOGdNQzArTWdvZ0lIWmxZeklnZW1WeWIxUnZWSGR2SUQwZ2VtVnliMVJ2VDI1bElDb2dNaTR3T3dvS0lDQXZMeUJqYjI1MlpYSjBJR1p5YjIwZ01DMCtNaUIwYnlBdE1TMCtLekVnS0dOc2FYQnpjR0ZqWlNrS0lDQjJaV015SUdOc2FYQlRjR0ZqWlNBOUlIcGxjbTlVYjFSM2J5QXRJREV1TURzS0NpQWdaMnhmVUc5emFYUnBiMjRnUFNCMlpXTTBLR05zYVhCVGNHRmpaU0FxSUhabFl6SW9NU3dnTFRFcExDQXdMQ0F4S1RzS0NpQWdMeThnY0dGemN5QjBhR1VnZEdWNFEyOXZjbVFnZEc4Z2RHaGxJR1p5WVdkdFpXNTBJSE5vWVdSbGNnb2dJQzh2SUZSb1pTQkhVRlVnZDJsc2JDQnBiblJsY25CdmJHRjBaU0IwYUdseklIWmhiSFZsSUdKbGRIZGxaVzRnY0c5cGJuUnpMZ29nSUhaZmRHVjRRMjl2Y21RZ1BTQmhYM1JsZUVOdmIzSmtPd3A5Q21Bc1puSmhaMjFsYm5SVGFHRmtaWEpUYjNWeVkyVTlZQ04yWlhKemFXOXVJRE13TUNCbGN3b0tMeThnWm5KaFoyMWxiblFnYzJoaFpHVnljeUJrYjI1MElHaGhkbVVnWVNCa1pXWmhkV3gwSUhCeVpXTnBjMmx2YmlCemJ5QjNaU0J1WldWa0NpOHZJSFJ2SUhCcFkyc2diMjVsTGlCb2FXZG9jQ0JwY3lCaElHZHZiMlFnWkdWbVlYVnNkQzRnU1hRZ2JXVmhibk1nSW1ocFoyZ2djSEpsWTJsemFXOXVJZ3B3Y21WamFYTnBiMjRnYUdsbmFIQWdabXh2WVhRN0Nnb3ZMeUJ2ZFhJZ2RHVjRkSFZ5WlFwMWJtbG1iM0p0SUhOaGJYQnNaWEl5UkNCMVgybHRZV2RsT3dvS0x5OGdkR2hsSUhScGJXVUtkVzVwWm05eWJTQm1iRzloZENCMVgzUnBiV1U3Q2dvdkx5QjBhR1VnZEdWNFEyOXZjbVJ6SUhCaGMzTmxaQ0JwYmlCbWNtOXRJSFJvWlNCMlpYSjBaWGdnYzJoaFpHVnlMZ3BwYmlCMlpXTXlJSFpmZEdWNFEyOXZjbVE3Q2dvdkx5QjNaU0J1WldWa0lIUnZJR1JsWTJ4aGNtVWdZVzRnYjNWMGNIVjBJR1p2Y2lCMGFHVWdabkpoWjIxbGJuUWdjMmhoWkdWeUNtOTFkQ0IyWldNMElHOTFkRU52Ykc5eU93b0tkbVZqTXlCdGIyUXlPRGtvZG1Wak15QjRLU0I3Q2lBZ2NtVjBkWEp1SUhnZ0xTQm1iRzl2Y2loNElDb2dLREV1TUNBdklESTRPUzR3S1NrZ0tpQXlPRGt1TURzS2ZRb0tkbVZqTWlCdGIyUXlPRGtvZG1Wak1pQjRLU0I3Q2lBZ2NtVjBkWEp1SUhnZ0xTQm1iRzl2Y2loNElDb2dLREV1TUNBdklESTRPUzR3S1NrZ0tpQXlPRGt1TURzS2ZRb0tkbVZqTXlCd1pYSnRkWFJsS0habFl6TWdlQ2tnZXdvZ0lISmxkSFZ5YmlCdGIyUXlPRGtvS0NoNEtqTTBMakFwS3pFdU1Da3FlQ2s3Q24wS0NtWnNiMkYwSUhOdWIybHpaU2gyWldNeUlIWXBDaUFnZXdvZ0lHTnZibk4wSUhabFl6UWdReUE5SUhabFl6UW9NQzR5TVRFek1qUTROalUwTURVeE9EY3NJQ0F2THlBb015NHdMWE54Y25Rb015NHdLU2t2Tmk0d0NpQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0F3TGpNMk5qQXlOVFF3TXpjNE5EUXpPU3dnSUM4dklEQXVOU29vYzNGeWRDZ3pMakFwTFRFdU1Da0tJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUMwd0xqVTNOek0xTURJMk9URTRPVFl5Tml3Z0lDOHZJQzB4TGpBZ0t5QXlMakFnS2lCRExuZ0tJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSURBdU1ESTBNemt3TWpRek9UQXlORE01S1RzZ0x5OGdNUzR3SUM4Z05ERXVNQW9nSUM4dklFWnBjbk4wSUdOdmNtNWxjZ29nSUhabFl6SWdhU0FnUFNCbWJHOXZjaWgySUNzZ1pHOTBLSFlzSUVNdWVYa3BJQ2s3Q2lBZ2RtVmpNaUI0TUNBOUlIWWdMU0FnSUdrZ0t5QmtiM1FvYVN3Z1F5NTRlQ2s3Q2dvZ0lDOHZJRTkwYUdWeUlHTnZjbTVsY25NS0lDQjJaV015SUdreE93b2dJQzh2YVRFdWVDQTlJSE4wWlhBb0lIZ3dMbmtzSUhnd0xuZ2dLVHNnTHk4Z2VEQXVlQ0ErSUhnd0xua2dQeUF4TGpBZ09pQXdMakFLSUNBdkwya3hMbmtnUFNBeExqQWdMU0JwTVM1NE93b2dJR2t4SUQwZ0tIZ3dMbmdnUGlCNE1DNTVLU0EvSUhabFl6SW9NUzR3TENBd0xqQXBJRG9nZG1Wak1pZ3dMakFzSURFdU1DazdDaUFnTHk4Z2VEQWdQU0I0TUNBdElEQXVNQ0FySURBdU1DQXFJRU11ZUhnZ093b2dJQzh2SUhneElEMGdlREFnTFNCcE1TQXJJREV1TUNBcUlFTXVlSGdnT3dvZ0lDOHZJSGd5SUQwZ2VEQWdMU0F4TGpBZ0t5QXlMakFnS2lCRExuaDRJRHNLSUNCMlpXTTBJSGd4TWlBOUlIZ3dMbmg1ZUhrZ0t5QkRMbmg0ZW5vN0NpQWdlREV5TG5oNUlDMDlJR2t4T3dvS0lDQXZMeUJRWlhKdGRYUmhkR2x2Ym5NS0lDQnBJRDBnYlc5a01qZzVLR2twT3lBdkx5QkJkbTlwWkNCMGNuVnVZMkYwYVc5dUlHVm1abVZqZEhNZ2FXNGdjR1Z5YlhWMFlYUnBiMjRLSUNCMlpXTXpJSEFnUFNCd1pYSnRkWFJsS0NCd1pYSnRkWFJsS0NCcExua2dLeUIyWldNektEQXVNQ3dnYVRFdWVTd2dNUzR3SUNrcENpQWdJQ0FySUdrdWVDQXJJSFpsWXpNb01DNHdMQ0JwTVM1NExDQXhMakFnS1NrN0Nnb2dJSFpsWXpNZ2JTQTlJRzFoZUNnd0xqVWdMU0IyWldNektHUnZkQ2g0TUN4NE1Da3NJR1J2ZENoNE1USXVlSGtzZURFeUxuaDVLU3dnWkc5MEtIZ3hNaTU2ZHl4NE1USXVlbmNwS1N3Z01DNHdLVHNLSUNCdElEMGdiU3B0SURzS0lDQnRJRDBnYlNwdElEc0tDaUFnTHk4Z1IzSmhaR2xsYm5Sek9pQTBNU0J3YjJsdWRITWdkVzVwWm05eWJXeDVJRzkyWlhJZ1lTQnNhVzVsTENCdFlYQndaV1FnYjI1MGJ5QmhJR1JwWVcxdmJtUXVDaUFnTHk4Z1ZHaGxJSEpwYm1jZ2MybDZaU0F4TnlveE55QTlJREk0T1NCcGN5QmpiRzl6WlNCMGJ5QmhJRzExYkhScGNHeGxJRzltSURReElDZzBNU28zSUQwZ01qZzNLUW9LSUNCMlpXTXpJSGdnUFNBeUxqQWdLaUJtY21GamRDaHdJQ29nUXk1M2QzY3BJQzBnTVM0d093b2dJSFpsWXpNZ2FDQTlJR0ZpY3loNEtTQXRJREF1TlRzS0lDQjJaV016SUc5NElEMGdabXh2YjNJb2VDQXJJREF1TlNrN0NpQWdkbVZqTXlCaE1DQTlJSGdnTFNCdmVEc0tDaUFnTHk4Z1RtOXliV0ZzYVhObElHZHlZV1JwWlc1MGN5QnBiWEJzYVdOcGRHeDVJR0o1SUhOallXeHBibWNnYlFvZ0lDOHZJRUZ3Y0hKdmVHbHRZWFJwYjI0Z2IyWTZJRzBnS2owZ2FXNTJaWEp6WlhOeGNuUW9JR0V3S21Fd0lDc2dhQ3BvSUNrN0NpQWdiU0FxUFNBeExqYzVNamcwTWpreE5EQXdNVFU1SUMwZ01DNDROVE0zTXpRM01qQTVOVE14TkNBcUlDZ2dZVEFxWVRBZ0t5Qm9LbWdnS1RzS0NpQWdMeThnUTI5dGNIVjBaU0JtYVc1aGJDQnViMmx6WlNCMllXeDFaU0JoZENCUUNpQWdkbVZqTXlCbk93b2dJR2N1ZUNBZ1BTQmhNQzU0SUNBcUlIZ3dMbmdnSUNzZ2FDNTRJQ0FxSUhnd0xuazdDaUFnWnk1NWVpQTlJR0V3TG5sNklDb2dlREV5TG5oNklDc2dhQzU1ZWlBcUlIZ3hNaTU1ZHpzS0lDQnlaWFIxY200Z01UTXdMakFnS2lCa2IzUW9iU3dnWnlrN0NuMEtDbVpzYjJGMElISmhibVFvZG1Wak1pQmpieWtLZXdvZ0lDQnlaWFIxY200Z1puSmhZM1FvYzJsdUtHUnZkQ2hqYnk1NGVTeDJaV015S0RFeUxqazRPVGdzTnpndU1qTXpLU2twSUNvZ05ETTNOVGd1TlRRMU15azdDbjBLQ25admFXUWdiV0ZwYmlncElIc0tJQ0FnSUM4dklISjFibk1nWm5KdmJTQXdMakFnZEc4Z01TNHdJRzl1SUdKdmRHZ2dZWGhwY3dvZ0lDQWdkbVZqTWlCMWRpQTlJSFpmZEdWNFEyOXZjbVF1ZUhrN0NpQWdJQ0JtYkc5aGRDQjBhVzFsSUQwZ2RWOTBhVzFsSUNvZ01pNHdPd29LSUNBZ0lDOHZJRU55WldGMFpTQnNZWEpuWlN3Z2FXNWphV1JsYm5SaGJDQnViMmx6WlNCM1lYWmxjd29nSUNBZ1pteHZZWFFnYm05cGMyVWdQU0J0WVhnb01DNHdMQ0J6Ym05cGMyVW9kbVZqTWloMGFXMWxMQ0IxZGk1NUlDb2dNQzR6S1NrZ0xTQXdMak1wSUNvZ0tERXVNQ0F2SURBdU55azdDZ29nSUNBZ0x5OGdUMlptYzJWMElHSjVJSE50WVd4c1pYSXNJR052Ym5OMFlXNTBJRzV2YVhObElIZGhkbVZ6Q2lBZ0lDQnViMmx6WlNBOUlHNXZhWE5sSUNzZ0tITnViMmx6WlNoMlpXTXlLSFJwYldVcU1UQXVNQ3dnZFhZdWVTQXFJREl1TkNrcElDMGdNQzQxS1NBcUlEQXVNVFU3Q2dvZ0lDQWdMeThnUVhCd2JIa2dkR2hsSUc1dmFYTmxJR0Z6SUhnZ1pHbHpjR3hoWTJWdFpXNTBJR1p2Y2lCbGRtVnllU0JzYVc1bENpQWdJQ0JtYkc5aGRDQjRjRzl6SUQwZ2RYWXVlQ0F0SUc1dmFYTmxJQ29nYm05cGMyVWdLaUF3TGpJMU93b2dJQ0FnYjNWMFEyOXNiM0lnUFNCMFpYaDBkWEpsS0hWZmFXMWhaMlVzSUhabFl6SW9lSEJ2Y3l3Z2RYWXVlU2twT3dvS0lDQWdJQzh2SUUxcGVDQnBiaUJ6YjIxbElISmhibVJ2YlNCcGJuUmxjbVpsY21WdVkyVWdabTl5SUd4cGJtVnpDaUFnSUNCdmRYUkRiMnh2Y2k1eVoySWdQU0J0YVhnb2IzVjBRMjlzYjNJdWNtZGlMQ0IyWldNektISmhibVFvZG1Wak1paDFkaTU1SUNvZ2RHbHRaU2twS1N3Z2JtOXBjMlVnS2lBd0xqTXBMbkpuWWpzS0NpQWdJQ0F2THlCQmNIQnNlU0JoSUhKMWJtNXBibWNnYkdsdVpTQndZWFIwWlhKdUxDQmtkWEpoZEdsdmJpQnBjeUE0SUhObFkyOXVaSE11SUhOcGJpZ3dMQ0J3YVNrZ1oyOWxjeUIwYnlBb01DNHdMQ0F4TGpBc0lEQXVNQ2tLSUNBZ0lHWnNiMkYwSUd4cGJtVmZjM1JoY25SZmVTQTlJRzF2WkNnd0xqRXlOU0FxSUhScGJXVXNJRE11TVRRcE93b2dJQ0FnYkdsdVpWOXpkR0Z5ZEY5NUlEMGdjMmx1S0d4cGJtVmZjM1JoY25SZmVTazdDaUFnSUNCcFppQW9kbDkwWlhoRGIyOXlaQzU1SUQ0Z2JHbHVaVjl6ZEdGeWRGOTVJQ1ltSUhaZmRHVjRRMjl2Y21RdWVTQThJR3hwYm1WZmMzUmhjblJmZVNBcklEQXVNRE1nS3lBd0xqQXhJQ29nS0RBdU5TQXRJRzV2YVhObEtTa0tJQ0FnSUhzS0lDQWdJQ0FnTHk4Z2RHRnJaU0JqYjJ4dmNuTWdNeVVnWm5KdmJTQjBhR1VnY21sbmFIUWdkRzhnWjJsMlpTQmhJSE5vYVdaMElHVm1abVZqZEFvZ0lDQWdJQ0J2ZFhSRGIyeHZjaTV5WjJKaElEMGdiV2w0S0c5MWRFTnZiRzl5TG5KblltRXNJSFJsZUhSMWNtVW9kVjlwYldGblpTd2dkbVZqTWloNGNHOXpJQ3NnTUM0d015QXRJRzV2YVhObElDb2dNQzR3TXl3Z2RYWXVlU2twTG5KblltRXNJREF1T0NrN0NpQWdJQ0FnSUc5MWRFTnZiRzl5TG1jZ1BTQnRhWGdvYjNWMFEyOXNiM0l1Y2l3Z2RHVjRkSFZ5WlNoMVgybHRZV2RsTENCMlpXTXlLSGh3YjNNZ0t5QnViMmx6WlNBcUlEQXVNRFVzSUhWMkxua3BLUzVuTENBd0xqVXBPd29nSUNBZ0lDQnZkWFJEYjJ4dmNpNWlJRDBnYldsNEtHOTFkRU52Ykc5eUxuSXNJSFJsZUhSMWNtVW9kVjlwYldGblpTd2dkbVZqTWloNGNHOXpJQzBnYm05cGMyVWdLaUF3TGpBMUxDQjFkaTU1S1NrdVlpd2dNQzQxS1RzS0lDQWdJSDBnWld4elpTQjdDaUFnSUNBZ0lHOTFkRU52Ykc5eUxtY2dQU0J0YVhnb2IzVjBRMjlzYjNJdWNpd2dkR1Y0ZEhWeVpTaDFYMmx0WVdkbExDQjJaV015S0hod2IzTWdLeUJ1YjJselpTQXFJREF1TURVc0lIVjJMbmtwS1M1bkxDQXdMallwT3dvZ0lDQWdJQ0J2ZFhSRGIyeHZjaTVpSUQwZ2JXbDRLRzkxZEVOdmJHOXlMbklzSUhSbGVIUjFjbVVvZFY5cGJXRm5aU3dnZG1Wak1paDRjRzl6SUMwZ2JtOXBjMlVnS2lBd0xqQTFMQ0IxZGk1NUtTa3VZaXdnTUM0MktUc0tJQ0FnSUgwS0NpQWdJQ0JtYkc5aGRDQnBiblJsY25CdmJHRjBhVzl1SUQwZ2JXOWtLSFJwYldVc0lEZ3VNQ2s3Q2lBZ0lDQm1iRzloZENCaGJYQnNhV1pwWlhJZ1BTQTFMakE3Q2lBZ0lDQnBaaWhwYm5SbGNuQnZiR0YwYVc5dUlEdzlJRGN1TUNrZ2V3b2dJQ0FnSUNCcGJuUmxjbkJ2YkdGMGFXOXVJRDBnYVc1MFpYSndiMnhoZEdsdmJpQXFJR2x1ZEdWeWNHOXNZWFJwYjI0Z0x5QTBPUzR3T3dvZ0lDQWdmU0JsYkhObElIc0tJQ0FnSUNBZ2FXNTBaWEp3YjJ4aGRHbHZiaUE5SURndU1DQXRJR2x1ZEdWeWNHOXNZWFJwYjI0N0NpQWdJQ0I5Q2lBZ0lDQnZkWFJEYjJ4dmNpNXlaMklnUFNCdGFYZ29iM1YwUTI5c2IzSXVjbWRpTENCMFpYaDBkWEpsS0hWZmFXMWhaMlVzSUhabFl6SW9lSEJ2Y3lBcklHNXZhWE5sSUNvZ01DNHdOU3dnZFhZdWVTa3BMbkpuWWl3Z1lXMXdiR2xtYVdWeUlDb2dhVzUwWlhKd2IyeGhkR2x2YmlrN0NuMEtZRHRtZFc1amRHbHZiaUJ5WlhOcGVtVkRZVzUyWVhOVWIwUnBjM0JzWVhsVGFYcGxLR1VzYmlsN2JqMXVmSHd4TzJOdmJuTjBJSFE5WlM1amJHbGxiblJYYVdSMGFDcHVmREFzYnoxbExtTnNhV1Z1ZEVobGFXZG9kQ3B1ZkRBN2NtVjBkWEp1S0dVdWQybGtkR2doUFQxMGZIeGxMbWhsYVdkb2RDRTlQVzhwSmlZb1pTNTNhV1IwYUQxMExHVXVhR1ZwWjJoMFBXOHNJVEFwZldaMWJtTjBhVzl1SUhKbGJtUmxjaWhsS1h0MllYSWdiajFrYjJOMWJXVnVkQzV4ZFdWeWVWTmxiR1ZqZEc5eUtDSWpZMkZ1ZG1Geklpa3NkRDF1TG1kbGRFTnZiblJsZUhRb0luZGxZbWRzTWlJcE8ybG1LQ0YwS1hKbGRIVnlianRqYjI1emRDQnZQWFF1WTNKbFlYUmxVMmhoWkdWeUtIUXVWa1ZTVkVWWVgxTklRVVJGVWlrN2RDNXphR0ZrWlhKVGIzVnlZMlVvYnl4MlpYSjBaWGhUYUdGa1pYSlRiM1Z5WTJVcExIUXVZMjl0Y0dsc1pWTm9ZV1JsY2lodktUdGpiMjV6ZENCeVBYUXVZM0psWVhSbFUyaGhaR1Z5S0hRdVJsSkJSMDFGVGxSZlUwaEJSRVZTS1R0MExuTm9ZV1JsY2xOdmRYSmpaU2h5TEdaeVlXZHRaVzUwVTJoaFpHVnlVMjkxY21ObEtTeDBMbU52YlhCcGJHVlRhR0ZrWlhJb2NpazdkbUZ5SUdrOWRDNWpjbVZoZEdWUWNtOW5jbUZ0S0NrN2RDNWhkSFJoWTJoVGFHRmtaWElvYVN4dktTeDBMbUYwZEdGamFGTm9ZV1JsY2locExISXBMSFF1YkdsdWExQnliMmR5WVcwb2FTazdkbUZ5SUdFOWRDNW5aWFJCZEhSeWFXSk1iMk5oZEdsdmJpaHBMQ0poWDNCdmMybDBhVzl1SWlrc2N6MTBMbWRsZEVGMGRISnBZa3h2WTJGMGFXOXVLR2tzSW1GZmRHVjRRMjl2Y21RaUtTeGpQWFF1WjJWMFZXNXBabTl5YlV4dlkyRjBhVzl1S0drc0luVmZjbVZ6YjJ4MWRHbHZiaUlwTEhnOWRDNW5aWFJWYm1sbWIzSnRURzlqWVhScGIyNG9hU3dpZFY5cGJXRm5aU0lwTEhVOWRDNW5aWFJWYm1sbWIzSnRURzlqWVhScGIyNG9hU3dpZFY5MGFXMWxJaWtzZGoxMExtTnlaV0YwWlZabGNuUmxlRUZ5Y21GNUtDazdkQzVpYVc1a1ZtVnlkR1Y0UVhKeVlYa29kaWs3ZG1GeUlHMDlkQzVqY21WaGRHVkNkV1ptWlhJb0tUdDBMbVZ1WVdKc1pWWmxjblJsZUVGMGRISnBZa0Z5Y21GNUtHRXBMSFF1WW1sdVpFSjFabVpsY2loMExrRlNVa0ZaWDBKVlJrWkZVaXh0S1R0MllYSWdiRDB5TEdZOWRDNUdURTlCVkN4a1BTRXhMR2c5TUN4d1BUQTdkQzUyWlhKMFpYaEJkSFJ5YVdKUWIybHVkR1Z5S0dFc2JDeG1MR1FzYUN4d0tUdDJZWElnWnoxMExtTnlaV0YwWlVKMVptWmxjaWdwTzNRdVltbHVaRUoxWm1abGNpaDBMa0ZTVWtGWlgwSlZSa1pGVWl4bktTeDBMbUoxWm1abGNrUmhkR0VvZEM1QlVsSkJXVjlDVlVaR1JWSXNibVYzSUVac2IyRjBNekpCY25KaGVTaGJNQ3d3TERFc01Dd3dMREVzTUN3eExERXNNQ3d4TERGZEtTeDBMbE5VUVZSSlExOUVVa0ZYS1N4MExtVnVZV0pzWlZabGNuUmxlRUYwZEhKcFlrRnljbUY1S0hNcE8ydzlNaXhtUFhRdVJreFBRVlFzWkQwaE1TeG9QVEFzY0Qwd08zUXVkbVZ5ZEdWNFFYUjBjbWxpVUc5cGJuUmxjaWh6TEd3c1ppeGtMR2dzY0NrN2RtRnlJRjg5ZEM1amNtVmhkR1ZVWlhoMGRYSmxLQ2s3ZEM1aFkzUnBkbVZVWlhoMGRYSmxLSFF1VkVWWVZGVlNSVEFyTUNrc2RDNWlhVzVrVkdWNGRIVnlaU2gwTGxSRldGUlZVa1ZmTWtRc1h5a3NkQzUwWlhoUVlYSmhiV1YwWlhKcEtIUXVWRVZZVkZWU1JWOHlSQ3gwTGxSRldGUlZVa1ZmVjFKQlVGOVRMSFF1UTB4QlRWQmZWRTlmUlVSSFJTa3NkQzUwWlhoUVlYSmhiV1YwWlhKcEtIUXVWRVZZVkZWU1JWOHlSQ3gwTGxSRldGUlZVa1ZmVjFKQlVGOVVMSFF1UTB4QlRWQmZWRTlmUlVSSFJTa3NkQzUwWlhoUVlYSmhiV1YwWlhKcEtIUXVWRVZZVkZWU1JWOHlSQ3gwTGxSRldGUlZVa1ZmVFVsT1gwWkpURlJGVWl4MExrNUZRVkpGVTFRcExIUXVkR1Y0VUdGeVlXMWxkR1Z5YVNoMExsUkZXRlJWVWtWZk1rUXNkQzVVUlZoVVZWSkZYMDFCUjE5R1NVeFVSVklzZEM1T1JVRlNSVk5VS1R0MllYSWdWRDEwTGxKSFFrRXNlVDEwTGxKSFFrRXNSVDEwTGxWT1UwbEhUa1ZFWDBKWlZFVTdkQzUwWlhoSmJXRm5aVEpFS0hRdVZFVllWRlZTUlY4eVJDd3dMRlFzZVN4RkxHVXBPM0psY1hWbGMzUkJibWx0WVhScGIyNUdjbUZ0WlNobWRXNWpkR2x2YmlCdktISXBlM0lxUFM0d01ERTdjaXh5WlhOcGVtVkRZVzUyWVhOVWIwUnBjM0JzWVhsVGFYcGxLSFF1WTJGdWRtRnpLU3gwTG5acFpYZHdiM0owS0RBc01DeDBMbU5oYm5aaGN5NTNhV1IwYUN4MExtTmhiblpoY3k1b1pXbG5hSFFwTEhRdVkyeGxZWEpEYjJ4dmNpZ3dMREFzTUN3d0tTeDBMbU5zWldGeUtIUXVRMDlNVDFKZlFsVkdSa1ZTWDBKSlZIeDBMa1JGVUZSSVgwSlZSa1pGVWw5Q1NWUXBMSFF1ZFhObFVISnZaM0poYlNocEtTeDBMbUpwYm1SV1pYSjBaWGhCY25KaGVTaDJLU3gwTG5WdWFXWnZjbTB5WmloakxIUXVZMkZ1ZG1GekxuZHBaSFJvTEhRdVkyRnVkbUZ6TG1obGFXZG9kQ2tzZEM1MWJtbG1iM0p0TVdZb2RTeHlLU3gwTG5WdWFXWnZjbTB4YVNoNExEQXBMSFF1WW1sdVpFSjFabVpsY2loMExrRlNVa0ZaWDBKVlJrWkZVaXh0S1N4elpYUlNaV04wWVc1bmJHVW9kQ3d3TERBc1pTNTNhV1IwYUN4bExtaGxhV2RvZEN4dUxuZHBaSFJvTEc0dWFHVnBaMmgwS1R0MllYSWdZVDEwTGxSU1NVRk9SMHhGVXp0MExtUnlZWGRCY25KaGVYTW9ZU3d3TERZcExISmxjWFZsYzNSQmJtbHRZWFJwYjI1R2NtRnRaU2h2S1gwcGZXWjFibU4wYVc5dUlITmxkRkpsWTNSaGJtZHNaU2hsTEc0c2RDeHZMSElzYVN4aEtYdDJZWElnY3oxdkwzSXNZejFoTEhnOVl5cHpPM2crYVNZbUtHTTlLSGc5YVNrdmN5azdkbUZ5SUhVOWJpeDJQVzRyZUN4dFBYUXNiRDEwSzJNN1pTNWlkV1ptWlhKRVlYUmhLR1V1UVZKU1FWbGZRbFZHUmtWU0xHNWxkeUJHYkc5aGRETXlRWEp5WVhrb1czVXNiU3gyTEcwc2RTeHNMSFVzYkN4MkxHMHNkaXhzWFNrc1pTNVRWRUZVU1VOZlJGSkJWeWw5WTI5dWMzUWdkWEpwTW5WeWJEMWxQVDVsTG5OMFlYSjBjMWRwZEdnb0ltbHdabk02THk4aUtUOWxMbkpsY0d4aFkyVW9JbWx3Wm5NNkx5OGlMQ0pvZEhSd2N6b3ZMMmx3Wm5NdWFXOHZhWEJtY3k4aUtUcGxMRlJQUzBWT1gxVlNTVDBpYVhCbWN6b3ZMMUZ0WlZOcVUybHVTSEJRYm0xWWJYTndUV3AzYVZoNVRqWjZVelJGT1hwalkyRnlhVWRTTTJwNFkyRlhkSEV2TVRJek5DSTdkbUZ5SUdsdFlXZGxQVzVsZHlCSmJXRm5aVHRtWlhSamFDaDFjbWt5ZFhKc0tGUlBTMFZPWDFWU1NTa3BMblJvWlc0b1pUMCtaUzVxYzI5dUtDa3BMblJvWlc0b1pUMCtibVYzSUZCeWIyMXBjMlVvYmowK2UyTnZibk4wSUhROWRYSnBNblZ5YkNobExtbHRZV2RsS1R0cGJXRm5aUzVqY205emMwOXlhV2RwYmowaVlXNXZibmx0YjNWeklpeHBiV0ZuWlM1emNtTTlkQ3hwYldGblpTNXZibXh2WVdROVpuVnVZM1JwYjI0b0tYdHVLR2x0WVdkbEtYMTlLU2t1ZEdobGJpaGxQVDU3Y21WdVpHVnlLR1VwZlNrdVkyRjBZMmdvWlQwK1kyOXVjMjlzWlM1bGNuSnZjaWhsS1NrN1BDOXpZM0pwY0hRK0lEd3ZZbTlrZVQ0OEwyaDBiV3crIiwiYXR0cmlidXRlcyI6W119";
        assertEq(tokenURI, metadata);

        tokenURI = enhancement.previewTokenURI(
            tokenId, underlyingTokenContract, underlyingTokenId
        );
        assertEq(tokenURI, metadata);
    }
}